"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const e=t=>{if(!t)return;const{attributes:n,element:o,elementName:i,value:s}=t,r=o||document.createElement(i||"div");if(n&&r instanceof HTMLElement)for(const[e,t]of Object.entries(n))r.setAttribute(e,String(t));if(s)if("string"==typeof s)r.innerHTML=s;else for(const t of Array.isArray(s)?s:[s]){const n=e(t);n&&r.appendChild(n)}return r},t=/px$/,n=e=>Number(e.replace(t,"")),o=e=>`twicpics-components ${e}`,i="undefined"!=typeof document,s=e=>{console.warn(o(e))},r=()=>{},a=(e,t)=>n=>{let o;return n&&`${n}`.replace(e,((e,t)=>o=t)),t?t(o):o},c=e=>{throw new Error(o(e))},d=(e,t="\\s")=>new RegExp(`^(?:${t})*(${Array.isArray(e)?e.join("|"):e})(?:${t})*$`),l=["center"];for(const e of["","bottom","top"])for(const t of["","left","right"])(t||e)&&l.push(e?t?`${e}-${t}`:e:t);const m=d(l),p=d("\\s*(\\d+)\\s*[x]\\s*(\\d+)\\s*"),u=d(["contain","cover"]),h=d(["maincolor","meancolor","none","preview"]),f=d("(\\d+(?:\\.\\d+)?)(?:\\s*[\\/:]\\s*(\\d+(?:\\.\\d+)?))?|(none)"),$=d(["debug","offline","production"]),w={debug:!1,class:"twic",domain:void 0,env:"production",handleShadowDom:r,maxDPR:void 0,path:"",step:void 0},g=()=>`.twic-w>.${w.class}-done+div,.twic-w>.${w.class}-poster-done+div{opacity:0 !important}.twic-w>.${w.class}-done,.twic-w>.${w.class}-poster-done{transform:none !important}`,v=e=>`data-${w.class}-${e}`,b=/\?|^\/*$/,y=/(^https?:\/\/[^/]+)\/*$/,T=[["anticipation","anticipation"],["class","class"],["maxDPR","max-dpr"],["step","step"]];var S=(e,t)=>{const{component:n,componentName:o,tag:i}=t,{computed:s}=n;e.component(o,Object.assign(Object.assign({},n),{name:o,computed:Object.assign(Object.assign({},s),i?{_is:()=>i}:{})}))};const _=(e,t,n)=>({type:e,default:n,validator:t&&(e=>t.test(String(e)))}),x=e=>_(String,e),D=(e,t)=>_([Boolean,String],e,t),N=_([Number,String],/^\d+$/),O=x(),V=/^(image:)?\/*/,E=e=>!isNaN(e)&&e>0,j=a(d(".+?")),M=d(".+?","[\\s\\/]"),P=/\b(?:(left|right)|(bottom|top))\b/g,k=e=>{const t=j(e);let n,o;if(t){let e;for(;e=P.exec(t);)e[1]?n=e[1]:o=e[2]}return{x:n,y:o}},z=j,A=e=>"string"==typeof e?e.trim():void 0,R=j,C=e=>{if(!e)return;let t;const n=p.exec(e);if(n){const[,,e,o]=n;t=`${e}x${o}`}return t},F={true:!0,false:!1,"":!0},H=e=>"boolean"==typeof e?e:void 0!==e&&(F[e.trim()]||!1),I=a(u),B=(e,t)=>{if("offline"!==w.env&&j(t)&&"none"!==e)return h.test(e)?e:"preview"},W=j,L=a(M,(e=>e&&`${e}/`)),q=e=>{if("none"===e)return 0;let t;if("number"==typeof e)t=e;else if(e){const n=f.exec(e);if(n){const[,,e,o]=n;t=(o?Number(o):1)/Number(e)}else t=1}return E(t)?t:void 0},J=e=>{if("number"!=typeof e){const t=j(e);e=t&&Number(t)}return E(e)?e:void 0},Y=e=>((e=j(e))||s("src is not provided"),"offline"===w.env?"":(e=>e?e.replace(V,`image:${w.path}`):"placeholder:red")(e)),G={true:"fade",false:"none",fade:"fade",zoom:"zoom",none:"none"},K=e=>{"boolean"!=typeof e&&(e=j(e)||!0);const t={};return String(e).split(/\s*\+\s*|\s+/).forEach((e=>t[`${G[e]||"fade"}`]=!0)),t},Q=j,U=j,X=j,Z=/^(?:(auth|placeholder|rel)|(image|media|video)|[^:]*):(\/*)((v[0-9]+(?=[/?]))?[^?]*(\?.*)?)$/,ee=({x:e,y:t},n,o)=>"contain"===n&&(o||(t?e?`${e} ${t}`:t:e)),te=({x:e,y:t},n,o,i,s=!1)=>{const r="contain"!==o&&(n||(t?e?`${t}-${e}`:t:e));return`${s?"debug/":""}${i||""}${r?`focus=${r}/`:""}`},ne=(e,t,n)=>{const o={};return t&&(o.transitionDuration=t),e&&(o.transitionDelay=e),n&&(o.transitionTimingFunction=n),o},oe=/\/?([^/?#.]+)(?:\.[^/?#]*)?(?:[?#].*)?$/,ie=(e,t)=>{if(!e){const n=oe.exec(t);e=n&&n[1]||"image"}return e},se=(e,t,n,o,i,s,r,a,c,d)=>{const l={},m=te(e,o,r,a,"debug"===w.env);return"string"==typeof t&&(l[v("bot")]=t||"/"),n&&(l[v("eager")]=""),i&&(l[v("intrinsic")]=i),s&&(l[v("poster")]=c,l[v("poster-transform")]=`${m}*/output=image`),c&&(l[v("src")]=c),void 0!==d&&(l[v("step")]=String(d)),m&&(l[v("transform")]=`${m}*`),l},re=(e,t,n,o,i,s,r,a,c,d,l,m,p)=>{const u=ne(d,l,m);p({anchor:e,focus:t,mode:n,placeholder:o,preTransform:s,ratio:r,src:a,transitions:c}),n&&(u.backgroundSize=n);const h=ee(e,n,i);return h&&(u.backgroundPosition=h),u},ae=(e,t,n,o,i,s)=>{const r=ne(o,i,s),a=ee(e,t,n);return a&&(r.objectPosition=a),t&&(r.objectFit=t),r},ce=(e,t)=>{const n=["twic-w"];return t.hasOwnProperty("none")||(t.hasOwnProperty("fade")&&n.push("twic-tf"),t.hasOwnProperty("zoom")&&n.push("twic-tz")),"offline"===w.env&&(n.push("twic-offline"),e||n.push("twic-nosrc")),n.join(" ")},de=e=>0===e?{height:"100%",paddingTop:"0"}:{paddingTop:void 0===e?"":100*e+"%"},le=new WeakMap,me=i&&"undefined"!=typeof MutationObserver&&new MutationObserver((e=>{for(const{target:t}of e){const e=le.get(t);e&&e.handleState()}})),pe=i&&"undefined"!=typeof ResizeObserver&&new ResizeObserver((e=>{for(const{target:t}of e){const e=le.get(t);e&&e.refreshBackground()}})),ue=new RegExp(`(?:\\s*)(?:${w.class}-)(done|error|loading)`);class he{constructor(e){this.handleState=()=>{if(this.stateHandler){let e="new";const{className:t}=this.media,n=ue.exec(t);n&&([,e]=n),this.stateHandler(e)}},this.refreshBackground=((e,t)=>{let n;const o=Object.assign({leading:!0,ms:0,trailing:!0},{ms:100});return(...t)=>{!n&&o.leading&&e(...t),clearTimeout(n),n=setTimeout((()=>{n=void 0,o.trailing&&e(...t)}),o.ms)}})((()=>{if(this.placeholderData){const e=((e,{anchor:t,focus:o,mode:i,placeholder:s,preTransform:r,src:a,ratio:c,transitions:d})=>{if(!s||!a||d.hasOwnProperty("zoom")||!w.domain)return"";const l=getComputedStyle(e),m=i||I(l.backgroundSize)||"cover";let p;p=0===c?"contain"===m?1:n(l.height)/Math.max(1,n(l.width)):null!=c?c:n(l.fontSize);let u=1e3,h=1e3;return p<1?u*=p:h/=p,u=Math.max(1,Math.round(u)),h=Math.max(1,Math.round(h)),(({debug:e,domain:t,path:n,output:o,quality:i,src:s,transform:r})=>{const a=`${t}/`,c=s.slice(0,a.length)===a,d=c?`media:${s.slice(a.length)}`:s,l=Z.exec(d),m=l&&l[2],p=e?"/debug":"",u=o?`/output=${o}`:"",h=m?n&&!c?`${n}${l[3]?l[3][0]:""}${l[4]}`:l[4]:d,f=i?`/quality=${i}`:"",$=r?`/${r}`:"";return`${a}${l&&(l[1]||l[5])?`v1${p}${$}${u}/${m?`${l[2]}:${h}`:h}${f}`:`${h}${l&&l[6]?"&":"?"}twic=v1${p}${$}${u}${f}`}`})({domain:w.domain,path:w.path,src:a,transform:`${te(t,o,i,r)}${m}=${h}x${u}`,output:s})})(this.placeHolderElement,this.placeholderData);e&&e!==this.savedWrapperBackground&&(this.savedWrapperBackground=e,this.placeHolderElement.style.backgroundImage=`url(${JSON.stringify(e)})`)}})),this.setMedia=e=>{e&&(w.handleShadowDom(e),this.media=e,le.set(this.media,this),this.placeHolderElement=e.nextElementSibling,me&&(me.observe(this.media,{attributes:!0,attributeFilter:["class"]}),this.handleState()),pe&&pe.observe(this.media))},this.setPlaceholderData=e=>{this.placeholderData=e,this.media&&this.refreshBackground()},this.destroy=()=>{this.media&&this.media&&pe&&pe.unobserve(this.media)},this.stateHandler=e}}const fe=/^(\*+)(.*[^*])(\*+)$/,$e=(e,t,n=!1)=>{const o=t.map((e=>"function"==typeof e?{f:e}:{s:n?`${e}`:fe.test(`${e}`)?`${`${e}`.replace(fe,"$2")}`:`p_${e}`}));return function(){return e(...o.map((({f:e,s:t})=>e?e(this):this[t])))}},we={p_isVideo(){return"video"===this._is}},ge={};for(const[e,t,n,o]of[["alt",O,z],["anchor",x(m),k],["bot",O,A],["focus",O,R],["intrinsic",x(p),C],["mode",x(u),I],["eager",D(null,!1),H],["placeholder",x(h),B,["placeholder","src"]],["position",O,W],["preTransform",O,L],["ratio",x(f),q],["src",O,Y],["step",N,J],["transition",D(null,!0),K],["transitionDelay",O,Q],["transitionDuration",O,U],["transitionTimingFunction",O,X]])we[`p_${e}`]=$e(n,o||[e],!0),ge[e]=t;for(const[e,t,n]of[["_alt",ie,["alt","src"]],["_dataAttributes",se,["anchor","bot","eager","focus","intrinsic","isVideo","mode","preTransform","src","step"]],["_style",ae,["anchor","mode","position","transitionDelay","transitionDuration","transitionTimingFunction"]],["_placeholderStyle",re,["anchor","focus","mode","placeholder","position","preTransform","ratio","src","transition","transitionDelay","transitionDuration","transitionTimingFunction",e=>e.observer.setPlaceholderData]],["_wrapperClass",ce,["src","transition"]],["_wrapperStyle",de,["ratio"]]])we[e]=$e(t,n);var ve={render:function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"twic-i"},[n("div",{class:e._wrapperClass,style:e._wrapperStyle},[n(e._is,e._b({ref:"media",tag:"component",style:e._style,attrs:{alt:e._alt}},"component",Object.assign({},e._dataAttributes),!1)),e._v(" "),n("div",{style:e._placeholderStyle})],1)])},staticRenderFns:[],props:ge,emits:["stateChange"],computed:we,beforeCreate(){this.observer=new he((e=>{this.$emit("stateChange",{target:this,state:e})}))},mounted(){this.observer.setMedia(this.$refs.media)},unmounted(){this.observer.destroy()}};const be={[v("view")]:""};var ye={render:function(){var e=this,t=e.$createElement;return(e._self._c||t)("div",e._b({},"div",e.viewAttributes,!1),[e._t("default")],2)},staticRenderFns:[],computed:{viewAttributes:()=>be}};exports.default=(t,n)=>{(t=>{t||c("install options not provided");const n=w&&w.domain,{domain:o,class:a,env:d,handleShadowDom:l,path:m}=t;if(o&&y.test(o)||c(`install domain "${o}" is invalid`),m&&b.test(m)&&c(`install path "${m}" is invalid`),d&&!$.test(d)&&c(`install env "${d}" is invalid`),w.class=a||"twic",w.domain=o.replace(y,"$1"),w.env=d,w.path=m?m.replace(/^\/*(.+?)\/*$/,"$1/"):"",w.handleShadowDom=l&&i?(t=>{const n=new WeakSet;return o=>{for(;o&&!n.has(o);){n.add(o);const{parentNode:i}=o;if(!i&&o instanceof ShadowRoot){if("closed"===o.mode)throw new Error("cannot use TwicPics components in closed ShadowRoot");e({element:o,value:{elementName:"style",value:`.twic-i{overflow:hidden}.twic-w,.twic-w *{border:none;margin:0;overflow:hidden;padding:0}.twic-w{overflow:hidden;position:relative;padding-top:100%;width:100%;padding-top:calc(100% / var(--twic-ratio,1))}.twic-w>*{display:block;left:0;height:100%;position:absolute;top:0;width:100%;transition-property:opacity,transform;will-change:opacity,transform;object-fit:cover;object-position:center;transition-delay:0s;transition-duration:.4s;transition-timing-function:ease;object-fit:var(--twic-mode,cover);object-position:var(--twic-position,center);transition-delay:var(--twic-transition-delay,0s);transition-duration:var(--twic-transition-duration,400ms);transition-timing-function:var(--twic-transition-timing-function,ease)}.twic-w>div{background-repeat:no-repeat;background-size:cover;background-position:center;background-size:var(--twic-mode,cover);background-position:var(--twic-position,center);font-size:calc(1px / var(--twic-ratio,1))}.twic-w>img:not([src]),.twic-w>img[src=\"\"]{visibility:hidden}.twic-w.twic-tz>img{transform:scale(0)}.twic-w.twic-tf>div{opacity:1}.twic-d{display:block;width:100%}.twic-offline{background-color:#ccc}.twic-offline.twic-nosrc{background-color:#fd0016}.twic-offline>*{display:none}${g()}`}}),(o=o.host)&&o.setAttribute(t,"")}else o=i}}})(v("component")):r,i){if(n)return void s("install function called multiple times");const i=[`${w.domain}/?v1`];T.forEach((e=>{const[n,o]=e;t.hasOwnProperty(n)&&t[n]&&i.push(`${o}=${t[n]}`)})),e({element:document.head,value:[{attributes:{rel:"preconnect",href:o},elementName:"link"},{attributes:{async:"",defer:"",src:i.join("&")},elementName:"script"},{value:g(),elementName:"style"}]})}})(n),n.TwicImg&&n.TwicImg===n.TwicVideo&&c("TwicImg and TwicVideo components must have different names"),n.TwicView&&n.TwicView===n.TwicImg&&c("TwicView and TwicImg components must have different names"),n.TwicView&&n.TwicView===n.TwicVideo&&c("TwicView and TwicVideo components must have different names"),S(t,{component:ve,componentName:n.TwicImg||"TwicImg",tag:"img"}),S(t,{component:ve,componentName:n.TwicVideo||"TwicVideo",tag:"video"}),S(t,{component:ye,componentName:n.TwicView||"TwicView"})};
//# sourceMappingURL=index.js.map
